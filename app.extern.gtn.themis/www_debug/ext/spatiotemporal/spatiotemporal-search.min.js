var SpatioTemporalUI=function(t){var e,n="http://localhost:9200/backmeup/_search?size=1500&q=",r=new Model,o=jQuery(t.resultList),i=new ResultList(o,r),a=jQuery(t.timeHistogram),u=new TimeHistogram(a,r),s=jQuery(t.map),l=new Map(s,r),c=function(){var t=jQuery('<div id="dateflipper"></div>');return o.parent().append(t),t}(),p=new DateFlipper(c[0]),f=function(t){r.load(n+encodeURIComponent(t),function(){l.render(),i.render(),u.render()})},h=function(t){console.log(t)},d=function(t){i.highlight(t),t.length>0&&i.scrollTo(t[0])},y=function(t){i.highlight(),i.scrollTo(r.getFirstResultBefore(t.to))},g=function(t){var n,r=$(window).height();e&&(clearTimeout(e),e=!1),c.fadeIn(),e=setTimeout(function(){c.fadeOut()},1200),jQuery(".resultListSection").toArray().some(function(t){var e=t.getBoundingClientRect().top;return r>e?(n=t,!1):!0}),p.set(new Date(jQuery(n).data("date")))};c.hide(),jQuery(window).scroll(g),l.on("select",d),u.on("select",y),i.on("select",h),this.update=f},HasEvents=function(){var t={};this.on=function(e,n){t[e]=n},this.fireEvent=function(e,n,r){t[e]&&t[e](n,r)}},Map=function(t,e){var n=this,r=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}),o=L.map(t[0],{center:new L.LatLng(48.2,16.4),zoom:12,layers:[r]}),i={},a=function(t){n.fireEvent("select",t),t.length>0&&s(t[0])},u=function(){jQuery.each(e.getResultsByCoordinate(),function(t,e){var n=L.marker([e.lat,e.lon]).on("click",a.bind(null,e.results)).addTo(o);jQuery.each(e.results,function(t,e){i[e.key]=n})})},s=function(t){if(t&&t.length>0){var e=i[t[0].key];e?e.bindPopup("<strong>"+t[0].title+"</strong>").openPopup():o.closePopup()}else o.closePopup()};this.render=u,this.selectFirst=s,HasEvents.apply(this)};Map.prototype=Object.create(Map.prototype);var Model=function(){var t=["album.html","albuminfo.xml","photo.jpg","commentinfo.xml","groups.html","groupinfo.xml","postinfo.xml","user.xml"],e={results:[],resultsByDate:[],resultsByCoordinate:[]},n=new WordList,r=function(t,n){jQuery.getJSON(t,function(t){e=i(t.hits.hits),n&&n()})},o=function(e){return jQuery.each(e,function(t,n){var r,o;"photoinfo.xml"===n.title&&(r=n.path.replace("photoinfo.xml","photo.jpg"),o=l("path",e)(r),n.title=!1,o?(n.createdAt=o.createdAt,n.path=o.path,n.contentType=o.contentType,n.thumbnail=o.thumbnail):(n.path=r,n.contentType="image-jpeg",n.thumbnail=r))}),jQuery.grep(e,function(e){return-1===t.indexOf(e.title)})},i=function(t){var e=function(){var e=t.map(function(t,e){var r=t._source;return r.fulltext&&n.append(r.fulltext),{key:e,title:r.filename,createdAt:r.document_creation_date?r.document_creation_date:r.backup_at,createdBy:r.authorName,thumbnail:r.thumbnail_path,dataSource:r.backup_source_plugin_id.replace(/\./g,"-"),contentType:r["Content-Type"].replace(/\.|\/|\+/g,"-"),lat:parseFloat(r.location_latitude),lon:parseFloat(r.location_longitude),path:r.path,_source:r}});return o(e)}(),r=function(){var t,n={},r=[];return jQuery.each(e,function(t,e){var r=e.createdAt-e.createdAt%864e5;r in n?n[r].push(e):n[r]=[e]}),t=Object.keys(n),t.sort(function(t,e){return e-t}),r=t.map(function(t){return{date:parseInt(t),results:n[t]}})}(),i=function(){var t,n={},r=[];return jQuery.each(e,function(t,e){var r=e.lat&&e.lon?e.lat+","+e.lon:!1;r&&(r in n?n[r].push(e):n[r]=[e])}),t=Object.keys(n),r=t.map(function(t){var e=t.split(","),r=n[t];return r.sort(function(t,e){return e.createdAt-t.createdAt}),{lat:parseFloat(e[0]),lon:parseFloat(e[1]),results:r}})}();return{results:e,resultsByDate:r,resultsByCoordinate:i}},a=function(t){return function(){return e[t]}},u=function(t){var e=t._source.fulltext;return e?TFIDF.compute(n,new WordList(e),3,.45):[]},s=function(t){var n;return e.resultsByDate.some(function(e){return e.date<=t?(n=e.results[0],!0):!1}),n},l=function(t,n){return function(r){var o,i=n?n:e.results;return i.some(function(e){return e[t]===r?(o=e,!0):!1}),o}};this.load=r,this.getFirstResultBefore=s,this.getResults=a("results"),this.getKeywords=u,this.getResultsByDate=a("resultsByDate"),this.getResultsByCoordinate=a("resultsByCoordinate"),this.findByKey=l("key"),this.findByPath=l("path")},ResultList=function(t,e){var n=this,r="https://pbs.twimg.com/profile_images/1814515189/picard1_400x400.jpg";MONTH_NAMES=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],listSectionHeadHeight=jQuery(".resultListSection h3").first().outerHeight(),formatDate=function(t){var e=new Date(t);return MONTH_NAMES[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()},createSection=function(t,n){var o,i='<div class="resultListSection" data-date="'+n+'"><h3>'+formatDate(n)+"</h3><ul>";return jQuery.each(t,function(t,n){var r=n.title?n.title:"",o=n.thumbnail?'<img class="thumbnail" src="'+n.thumbnail+'">':'<div class="thumbnail"></div>',a="resultContainer "+n.key+" "+n.dataSource+" "+n.contentType,u=e.getKeywords(n).map(function(t){return"<span>"+t.term+"</span>"}).join("");i+='<li><div class="'+a+'" data-key="'+n.key+'">'+o+'<span class="title">'+r+'</span><div class="date created"><span class="label">Erstellt: </span>'+formatDate(n.createdAt)+'</div><div class="keywords">'+u+"</div></div></li>"}),i+="</ul></div>",o=jQuery(i),o.find("img").on("error",function(t){t.target.src=r}),o},highlight=function(t){if(jQuery(".resultContainer").removeClass("selected"),t){var e=t.map(function(t){return"."+t.key}).join(", ");jQuery(e).addClass("selected")}},scrollTo=function(t){var e=jQuery(".resultContainer."+t.key);jQuery("html, body").animate({scrollTop:e.position().top-listSectionHeadHeight},500)},render=function(){jQuery.each(e.getResultsByDate(),function(e,n){t.append(createSection(n.results,n.date))})},t.on("click",".resultContainer",function(t){var r=jQuery(t.target).closest(".resultContainer");n.fireEvent("select",e.findByKey(r.data("key")))}),this.render=render,this.highlight=highlight,this.scrollTo=scrollTo,HasEvents.apply(this)};ResultList.prototype=Object.create(ResultList.prototype);var WordList=function(t){var e=function(t,e){var n=e?e:{},r=function(t){return t.replace(/\[|\.|,|\]|:|\"/g,"").trim()},o=t.replace(/(?:\r\n|\r|\n)/g," ").replace(/\t/g," ").split(" ");return o=jQuery.grep(o,function(t){var e=t.trim().length,n=new Date(t),r=parseFloat(t);return e>1&&0!==t.indexOf("http://")&&0!==t.indexOf("https://")&&0!==t.indexOf("href=")&&isNaN(n.getTime())&&isNaN(r)}),jQuery.each(o,function(t,e){var o=r(e),i=n[o];i?n[o]=i+1:n[o]=1}),n},n=function(t){e(t,r)},r=t?e(t):{};this.terms=r,this.append=n},TFIDF={compute:function(t,e,n,r){var o,i,a,u=t.terms,s=e.terms,l={},c=[];for(o in s)s.hasOwnProperty(o)&&(i=s[o],a=u[o],l[o]=i/a);for(o in l)l.hasOwnProperty(o)&&c.push({term:o,score:l[o]});return c.sort(function(t,e){return e.count-t.count}),r&&(c=jQuery.grep(c,function(t){return t.score>=r})),n?c.slice(0,n):c}},TimeHistogram=function(t,e){var n=this,r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],o=(new Date).getTime(),i=function(){return e.getResultsByDate().map(function(t){return{x:o-t.date,y:t.results.length}})},a=function(){var e=new SimpleHistogram(t,{data:i(),bins:36,logScale:!0,align:"right",tooltip:function(t,e,n){var i=new Date(o-t),a=new Date(o-e);return n+" results from "+r[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()+" to "+r[i.getMonth()]+" "+i.getDate()+", "+i.getFullYear()}});return e.on("click",function(t,e,r){var i=o-e,a=o-t;n.fireEvent("select",{from:i,to:a})}),e}(),u=function(){a.setData(i()),a.redraw()};this.render=u,HasEvents.apply(this)};TimeHistogram.prototype=Object.create(TimeHistogram.prototype);