var SimpleHistogram=function(t,e){var n,r=function(t,n){return e&&e[t]?e[t]:n},a=r("align","bottom"),i="bottom"===a?"landscape":"portrait",o=r("bins",20),u=r("logScale",!1),s=r("tooltip",!1),l=function(){var e="landscape"===i?Math.floor(jQuery(t).innerWidth()/o):Math.floor(jQuery(t).innerHeight()/o);return e},c=l(),p=r("data",[]),f=jQuery(t),d={},h=function(t,e,n){var r=0,a=jQuery.grep(t,function(t){return t.x>=e&&t.x<n});return jQuery.each(a,function(t,e){r+=e.y}),r},y=function(t,e){var r,a,i,o,u=[];if(t.length>0)for(r=t[0].x,a=t[t.length-1].x,n=(a-r)/e,o=0;e>o;o++)i=r+n*o,u.push({x:i,y:h(t,i,i+n)});return u},m=function(){var t=y(p,o),e=Math.max.apply(null,jQuery.map(t,function(t){return t.y})),r="landscape"===i?"width":"height",l="landscape"===i?"height":"width";u&&(e=Math.log(e)),f.empty(),jQuery.each(t,function(t,o){var p=u?Math.log(o.y+1)/e*100:o.y/e*100,d=s?s(o.x,o.x+n,o.y):o.y,h='<div class="histogram column '+a+" "+i+'" style="'+r+":"+c+'px" data-x="'+o.x+'" data-y="'+o.y+'" title="'+d+'"><div class="histogram bar" style="'+l+": "+p+'%"></div></div>';f.append(h)})},g=function(t){p=t,m()},v=function(){c=l(),m()},j=function(t,e){var n=d[t];n?n.push(e):d[t]=[e]},Q=function(t,e){if(t){var r=jQuery(e.target).closest(".column"),a=r.data("x"),i=a+n,o=r.data("y");jQuery.each(t,function(t,n){n(a,i,o,e)})}};jQuery(window).on("resize",v),f.on("mouseenter",".column",function(t){Q(d.enterbar,t)}),f.on("click",".column",function(t){Q(d.click,t)}),m(),this.on=j,this.redraw=v,this.setData=g},DateFlipper=function(t,e){var n,r,a,i,o=150,u=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],s=jQuery('<div class="dateflipper-container"><div class="dateflipper-col dateflipper-col-year"><p class="dateflipper-field">2015</p></div><div class="dateflipper-col dateflipper-col-month"><p class="dateflipper-field">Sept</p></div><div class="dateflipper-col dateflipper-col-day"><p class="dateflipper-field">17</p></div></div>'),l=!1,c=!1,p=s.find(".dateflipper-col-year"),f=s.find(".dateflipper-col-month"),d=s.find(".dateflipper-col-day"),h=function(){jQuery(t).append(s)},y=function(t,e,n){var r=t.children().first(),a=r.outerHeight(),i=t.position().top;t.append('<p class="dateflipper-field">'+e+"</p>"),t.animate({top:i-a},{duration:o,complete:function(){r.remove(),t.css("top",i),n()}})},m=function(t,e,n){var r=t.children().last(),a=r.outerHeight(),i=t.position().top;t.css("top",i-a),t.prepend('<p class="dateflipper-field">'+e+"</p>"),t.animate({top:i},{duration:o,complete:function(){r.remove(),n()}})},g=function(t,e,n){var r=c;t&&e&&n&&(l=!1,c&&(c=!1,v(r)))},v=function(t){var e=t.getFullYear(),o=u[t.getMonth()],s=t.getDate(),h=!1,v=!1,j=!1,Q=0>n-t?y:m;l?c=t:(l=!0,n=new Date(t.getTime()),e===r?h=!0:(r=e,Q(p,e,function(){h=!0,g(h,v,j)})),o===a?v=!0:(a=o,Q(f,o,function(){v=!0,g(h,v,j)})),s===i?j=!0:(i=s,Q(d,s,function(){j=!0,g(h,v,j)})),g(h,v,j))};h(),this.set=v},SpatioTemporalUI=function(t){var e,n=new Model({token:t.token}),r=jQuery(t.resultList),a=new ResultList(r,n),i=jQuery(t.timeHistogram),o=new TimeHistogram(i,n),u=jQuery(t.map),s=new Map(u,n,t.imagePath),l=function(){var t=jQuery('<div id="dateflipper"></div>');return r.parent().append(t),t}(),c=new DateFlipper(l),p=function(t){n.load(t,function(){s.render(),a.render(),o.render()})},f=function(t){console.log(t)},d=function(t){a.highlight(t),t.length>0&&a.scrollTo(t[0])},h=function(t){a.highlight(),a.scrollTo(n.getFirstResultBefore(t.to))},y=function(t){var n,r,a=$(window).height();e&&(clearTimeout(e),e=!1),l.fadeIn(),e=setTimeout(function(){l.fadeOut()},1200),jQuery(".resultListSection").toArray().some(function(t){var e=t.getBoundingClientRect().top;return a>e?(n=t,!1):!0}),r=jQuery(n).data("date"),r&&c.set(new Date(r))};l.hide(),jQuery(document).scroll(y),s.on("select",d),o.on("select",h),a.on("select",f),this.update=p},HasEvents=function(){var t={};this.on=function(e,n){t[e]=n},this.fireEvent=function(e,n,r){t[e]&&t[e](n,r)}},Map=function(t,e,n){var r=this,a=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}),i=L.map(t[0],{center:new L.LatLng(48.2,16.4),zoom:12,layers:[a]}),o=L.featureGroup().addTo(i),u={},s=function(t){r.fireEvent("select",t),t.length>0&&p(t[0])},l=function(){u={},o.clearLayers()},c=function(){i.invalidateSize(),l(),jQuery.each(e.getResultsByCoordinate(),function(t,e){var n=L.marker([e.lat,e.lon]).on("click",s.bind(null,e.results)).addTo(o);jQuery.each(e.results,function(t,e){u[e.key]=n})}),o.getLayers().length>0&&i.fitBounds(o.getBounds())},p=function(t){if(t&&t.length>0){var e=u[t[0].key];e?e.bindPopup("<strong>"+t[0].title+"</strong>").openPopup():i.closePopup()}else i.closePopup()};n&&(L.Icon.Default.imagePath=n),this.render=c,this.selectFirst=p,HasEvents.apply(this)};Map.prototype=Object.create(Map.prototype);var Model=function(t){var e="http://localhost:9200/backmeup/_search?size=1500&q=",n=["album.html","albuminfo.xml","photo.jpg","commentinfo.xml","groups.html","groupinfo.xml","postinfo.xml","user.xml"],r={results:[],resultsByDate:[],resultsByCoordinate:[]},a=new WordList,i=function(t){r=h(t.files)},o=function(t,e){jQuery.getJSON(t,function(t){r=d(t.hits.hits),e&&e()})},u=function(t,n){"string"===jQuery.type(t)?(console.log('Searching ElasticSearch for "'+t+'"'),o(e+encodeURIComponent(t),n)):(console.log("Normalizing THEMIS search results"),i(t),n&&n())},s=function(t){return jQuery.each(t,function(e,n){var r,a;"photoinfo.xml"===n.title&&(r=n.path.replace("photoinfo.xml","photo.jpg"),a=v("path",t)(r),n.title=!1,a?(n.createdAt=a.createdAt,n.path=a.path,n.contentType=a.contentType,n.thumbnail=a.thumbnail):(n.path=r,n.contentType="image-jpeg",n.thumbnail=r))}),jQuery.grep(t,function(t){return-1===n.indexOf(t.title)})},l=function(t){return t.map(function(t,e){var n=t._source;return n.fulltext&&a.append(n.fulltext),{key:e,title:n.filename,createdAt:n.document_creation_date?n.document_creation_date:n.backup_at,createdBy:n.authorName,thumbnail:n.thumbnail_path,fulltext:n.fulltext,dataSource:n.backup_source_plugin_id.replace(/\./g,"-"),contentType:n["Content-Type"].replace(/\.|\/|\+/g,"-"),lat:parseFloat(n.location_latitude),lon:parseFloat(n.location_longitude),path:n.path,_source:n}})},c=function(e){return e.map(function(e,n){return e.preview&&a.append(e.preview),{key:n,title:e.title,createdAt:e.metadata.document_creation_date?parseInt(e.metadata.document_creation_date):e.timeStamp,createdBy:e.ownerId,thumbnail:e.thumbnailUrl?e.thumbnailUrl.replace("###TOKEN###",encodeURIComponent(t.token)):!1,fulltext:e.preview,dataSource:e.dataSource,contentType:e.type,_source:e}})},p=function(t){var e,n={},r=[];return jQuery.each(t,function(t,e){var r=e.createdAt-e.createdAt%864e5;r in n?n[r].push(e):n[r]=[e]}),e=Object.keys(n),e.sort(function(t,e){return e-t}),r=e.map(function(t){return{date:parseInt(t),results:n[t]}})},f=function(t){var e,n={},r=[];return jQuery.each(t,function(t,e){var r=e.lat&&e.lon?e.lat+","+e.lon:!1;r&&(r in n?n[r].push(e):n[r]=[e])}),e=Object.keys(n),r=e.map(function(t){var e=t.split(","),r=n[t];return r.sort(function(t,e){return e.createdAt-t.createdAt}),{lat:parseFloat(e[0]),lon:parseFloat(e[1]),results:r}})},d=function(t){var e=s(l(t));return{results:e,resultsByDate:p(e),resultsByCoordinate:f(e)}},h=function(t){var e=s(c(t));return{results:e,resultsByDate:p(e),resultsByCoordinate:f(e)}},y=function(t){return function(){return r[t]}},m=function(t){var e=t.fulltext;return e?TFIDF.compute(a,new WordList(e),3,.45):[]},g=function(t){var e;return r.resultsByDate.some(function(n){return n.date<=t?(e=n.results[0],!0):!1}),e},v=function(t,e){return function(n){var a,i=e?e:r.results;return i.some(function(e){return e[t]===n?(a=e,!0):!1}),a}};this.load=u,this.getFirstResultBefore=g,this.getResults=y("results"),this.getKeywords=m,this.getResultsByDate=y("resultsByDate"),this.getResultsByCoordinate=y("resultsByCoordinate"),this.findByKey=v("key"),this.findByPath=v("path")},ResultList=function(t,e){var n=this,r="https://pbs.twimg.com/profile_images/1814515189/picard1_400x400.jpg",a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],i=jQuery(".resultListSection h3").first().outerHeight(),o=function(t){var e=new Date(t);return a[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()},u=function(t,n){var a,i='<div class="resultListSection" data-date="'+n+'"><h3>'+o(n)+"</h3><ul>";return jQuery.each(t,function(t,n){var r=n.title?n.title:"",a=n.thumbnail?'<img class="thumbnail" src="'+n.thumbnail+'">':'<div class="thumbnail"></div>',u="resultContainer "+n.key+" "+n.dataSource+" "+n.contentType,s=e.getKeywords(n).map(function(t){return"<span>"+t.term+"</span>"}).join("");i+='<li><div class="'+u+'" data-key="'+n.key+'">'+a+'<span class="title">'+r+'</span><div class="date created"><span class="label">Erstellt: </span>'+o(n.createdAt)+'</div><div class="keywords">'+s+"</div></div></li>"}),i+="</ul></div>",a=jQuery(i),a.find("img").on("error",function(t){t.target.src=r}),a},s=function(t){if(jQuery(".resultContainer").removeClass("selected"),t){var e=t.map(function(t){return"."+t.key}).join(", ");jQuery(e).addClass("selected")}},l=function(t){var e=jQuery(".resultContainer."+t.key);jQuery("html, body").animate({scrollTop:e.position().top-i},500)},c=function(){t.empty(),jQuery.each(e.getResultsByDate(),function(e,n){t.append(u(n.results,n.date))})};t.on("click",".resultContainer",function(t){var r=jQuery(t.target).closest(".resultContainer");n.fireEvent("select",e.findByKey(r.data("key")))}),this.render=c,this.highlight=s,this.scrollTo=l,HasEvents.apply(this)};ResultList.prototype=Object.create(ResultList.prototype);var WordList=function(t){var e=function(t,e){var n=e?e:{},r=function(t){return t.replace(/\[|\.|,|\]|:|\"/g,"").trim()},a=t.replace(/(?:\r\n|\r|\n)/g," ").replace(/\t/g," ").split(" ");return a=jQuery.grep(a,function(t){var e=t.trim().length,n=new Date(t),r=parseFloat(t);return e>1&&0!==t.indexOf("http://")&&0!==t.indexOf("https://")&&0!==t.indexOf("href=")&&isNaN(n.getTime())&&isNaN(r)}),jQuery.each(a,function(t,e){var a=r(e),i=n[a];i?n[a]=i+1:n[a]=1}),n},n=function(t){e(t,r)},r=t?e(t):{};this.terms=r,this.append=n},TFIDF={compute:function(t,e,n,r){var a,i,o,u=t.terms,s=e.terms,l={},c=[];for(a in s)s.hasOwnProperty(a)&&(i=s[a],o=u[a],l[a]=i/o);for(a in l)l.hasOwnProperty(a)&&c.push({term:a,score:l[a]});return c.sort(function(t,e){return e.count-t.count}),r&&(c=jQuery.grep(c,function(t){return t.score>=r})),n?c.slice(0,n):c}},TimeHistogram=function(t,e){var n=this,r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],a=(new Date).getTime(),i=function(){return e.getResultsByDate().map(function(t){return{x:a-t.date,y:t.results.length}})},o=function(){var e=new SimpleHistogram(t,{data:i(),bins:36,logScale:!0,align:"right",tooltip:function(t,e,n){var i=new Date(a-t),o=new Date(a-e);return n+" results from "+r[o.getMonth()]+" "+o.getDate()+", "+o.getFullYear()+" to "+r[i.getMonth()]+" "+i.getDate()+", "+i.getFullYear()}});return e.on("click",function(t,e,r){var i=a-e,o=a-t;n.fireEvent("select",{from:i,to:o})}),e}(),u=function(){o.setData(i()),o.redraw()};this.render=u,HasEvents.apply(this)};TimeHistogram.prototype=Object.create(TimeHistogram.prototype);